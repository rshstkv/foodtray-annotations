# BBox Annotation UI Redesign

## Текущие проблемы

### 1. Варианты блюд (Multiple BBox для одного блюда)
**Проблема:** Когда у блюда #2 есть 2 bbox (например, на Main изображении), один вариант подсвечен как "главный", хотя главного нет. Оба bbox равноценны.

**Пример:**
```
#2 [2 вар.]                    2/1
Sopa de Legumes sem Batata
• Sopa Juliana                 ← второй вариант "скрыт"
```

**Ожидаемое поведение:**
- Все bbox должны быть видны как отдельные элементы
- Каждый bbox можно удалить независимо из левого списка
- Нет "главного" варианта

### 2. Варианты зависят от изображения
**Важно:** Количество bbox для одного блюда может различаться на разных изображениях:
- Main (45°): 3 bbox для блюда #2
- Qualifying (90°): 1 bbox для блюда #2

Это нормально и должно корректно отображаться.

### 3. Дублирование горячих клавиш
**Проблема:** Горячие клавиши отображаются в двух местах:
- Сверху (полоса с hints)
- Слева в панели (большой блок)

**Ожидаемое:** Только одно место - компактная динамическая подсказка наверху.

### 4. Лишние элементы интерфейса
**Убрать:**
- ❌ Кнопка "Только выбранное" (лишняя)
- ❌ Кнопка "Завершить" слева (статус относится к recognition, не к панели)
- ❌ Чекбокс "Ошибка в чеке" (должно быть свойством блюда, если нет matches)
- ❌ Кнопка "Добавить блюдо" (это часть workflow после рисования bbox)

**Заменить:**
- "Сохранить" (Ctrl+S) → "Done" (каждое действие автосохраняется)

---

## Новая архитектура интерфейса

### Layout
```
┌─────────────────────────────────────────────────────────────────┐
│ Recognition 62764        [← Назад к списку]  [Done]             │ ← Header
│ 09.10.2025              Статус: ⚙️ В работе                     │
├─────────────────────────────────────────────────────────────────┤
│ Hotkeys: 1-9 блюдо | 2,2,2 следующий | Del удалить | Esc сброс │ ← Динамические hints
├──────────────┬──────────────────────────────────────────────────┤
│ Left Panel   │ Image Panel                                      │
│              │                                                   │
│ Список bbox  │ [Main (45°)] [Qualifying (90°)]                  │
│ по блюдам    │                                                   │
│              │ ┌──────────────────────────────────────┐          │
│ #1 (1 bbox)  │ │                                      │          │
│ #2 (2 bbox)  │ │   [Изображение с bbox]               │          │
│  ├─ bbox 1   │ │                                      │          │
│  └─ bbox 2   │ │                                      │          │
│ #3 (1 bbox)  │ └──────────────────────────────────────┘          │
│              │                                                   │
│ [Нарисовать] │                                                   │
└──────────────┴──────────────────────────────────────────────────┘
```

---

## Workflow: Добавление нового bbox

### Шаг 1: Рисование
Пользователь нажимает "Нарисовать bbox" или hotkey `D`, рисует прямоугольник на изображении.

### Шаг 2: Выбор типа объекта
После рисования появляется **dropdown рядом с bbox** (как сейчас) с опциями:

```
┌────────────────────────────────┐
│ Что вы добавили?               │
├────────────────────────────────┤
│ 📋 Блюда из чека (N)           │ ← correct_dishes
│   #1 REF S/GÁS B! LIMONADA     │
│   #2 Sopa de Legumes           │
│   ...                          │
├────────────────────────────────┤
│ 🍽️ Активное меню (поиск)      │ ← Таблица AM (active_menu)
│   [Поиск по EAN/Name...]       │
│   > Результаты                 │
├────────────────────────────────┤
│ 📦 Non-food объект             │ ← Hardcoded список
│   • Кошелек                    │
│   • Часы                       │
│   • Карта                      │
│   • Телефон                    │
│   • Другое                     │
└────────────────────────────────┘
```

### Шаг 3: Сохранение
После выбора bbox создаётся и появляется в левом списке.

---

## Левая панель: Список bbox

### Структура
Группировка по блюдам из чека + non-food объекты отдельно:

```
Блюда из чека:

┌──────────────────────────────────┐
│ 🟢 #1 REF S/GÁS B! LIMONADA      │  1/1
│    └─ bbox #1   [🗑️]             │
└──────────────────────────────────┘

┌──────────────────────────────────┐
│ 🔵 #2 Sopa de Legumes sem Batata │  2/1
│    ├─ bbox #1   [🗑️]             │ ← Можно удалить
│    └─ bbox #2   [🗑️]             │ ← Можно удалить
└──────────────────────────────────┘

┌──────────────────────────────────┐
│ 🟠 #3 Almôndegas                 │  1/1
│    └─ bbox #1   [🗑️]             │
└──────────────────────────────────┘

Non-food объекты:

┌──────────────────────────────────┐
│ 📦 Кошелек                       │
│    └─ bbox #1   [🗑️]             │
└──────────────────────────────────┘
```

### Взаимодействие
- **Клик на bbox** → выделяется на изображении
- **🗑️ кнопка** → удаление конкретного bbox
- **Клик на блюдо (#2)** → выделяет все bbox этого блюда на изображении

---

## Горячие клавиши

### Динамическая подсказка наверху
**Формат:** Тонкая строка (1 линия) с контекстными hints.

#### Контекст 1: Нормальный режим
```
Hotkeys: 1-9 выбрать блюдо | 2,2,2 следующий bbox | Del удалить | H показать все | Esc сброс
```

#### Контекст 2: Режим рисования
```
Hotkeys: Нарисуйте bbox мышью | Esc отменить
```

#### Контекст 3: Выбран bbox
```
Hotkeys: 2 следующий bbox блюда #2 | Del удалить | Esc снять выделение
```

### Логика навигации

#### Простая циклическая навигация (БЕЗ `0`)
**Убрать** сложную логику `X0Y` (201, 202...).

**Новая логика:**
- `2` → Выбрать блюдо #2, первый bbox
- `2` (повторно) → Следующий bbox блюда #2
- `2` (ещё раз) → По кругу к первому bbox

**Пример:**
```
Нажатия:  2     2     2     2
Выбор:    #2.1  #2.2  #2.1  #2.2  (циклично)
```

**Удаление:**
- Выбрали bbox → `Delete` → удалён
- Автоматически выбирается следующий bbox того же блюда (если есть)

#### Быстрое переключение между блюдами
```
Нажатия:  2     3     1
Выбор:    #2.1  #3.1  #1.1
```

---

## База данных: Активное меню (AM)

### Требование
Нужна таблица или поле для "активного меню" - блюда, доступные в конкретную дату.

### Вопрос к команде
**Какая структура уже есть?**
- a) Таблица `active_menu` с датами?
- b) Поле в `menu_items` (флаг/статус)?
- c) Нужно создать новую таблицу?

### Использование
При выборе "Активное меню" в dropdown:
1. Поиск по EAN (точное совпадение)
2. Поиск по Name (fuzzy search)
3. Фильтр по дате recognition

---

## Non-food объекты

### Hardcoded список
```typescript
const NON_FOOD_OBJECTS = [
  { id: 'wallet', name: 'Кошелек', icon: '👛' },
  { id: 'watch', name: 'Часы', icon: '⌚' },
  { id: 'card', name: 'Карта', icon: '💳' },
  { id: 'phone', name: 'Телефон', icon: '📱' },
  { id: 'keys', name: 'Ключи', icon: '🔑' },
  { id: 'other', name: 'Другое', icon: '📦' }
]
```

### Сохранение в БД
```typescript
{
  object_type: 'non_food',
  object_subtype: 'wallet', // или 'watch', 'card'...
  dish_index: null // non-food не привязан к блюду
}
```

---

## "Ошибка в блюде" - новая логика

### Текущая проблема
Чекбокс "Ошибка в чеке" отдельно - непонятно к чему относится.

### Новая логика
**Ошибка = не нашли блюдо нигде:**
1. Пользователь рисует bbox
2. Не находит совпадение в чеке
3. Не находит в активном меню
4. Выбирает → "❌ Не найдено (ошибка)"

**Сохранение:**
```typescript
{
  object_type: 'plate',
  dish_index: null, // не привязан
  is_error: true // маркер ошибки
}
```

**Статус recognition:**
- Если `ANY bbox has is_error === true` → recognition помечается как "есть ошибки"
- Автоматически при добавлении/удалении bbox

---

## Статус recognition

### Размещение
**НЕ** в левой панели - это свойство всего recognition.

**Размещение:** Header (правый верхний угол):
```
┌─────────────────────────────────────────────┐
│ Recognition 62764                           │
│ 09.10.2025                                  │
│ Статус: ⚙️ В работе  [Done]                 │
└─────────────────────────────────────────────┘
```

### Логика статусов
- `pending` → Новый
- `in_progress` → Любое изменение (авто)
- `completed` → Нажата кнопка "Done"
- `rejected` → Админ отклонил (не из UI)

---

## Упрощение кнопок

### До
```
┌──────────────────────────────┐
│ [Нарисовать bbox]            │
│ [👁️ Только выбранное]        │ ← УБРАТЬ
│ [✓ Завершить]                │ ← УБРАТЬ (перенести наверх)
│ [+ Добавить блюдо]           │ ← УБРАТЬ (часть workflow)
│                              │
│ Горячие клавиши:             │ ← УБРАТЬ (перенести наверх)
│ 1-9 выбрать...               │
│ ...                          │
│                              │
│ Статус: В работе             │ ← УБРАТЬ (перенести наверх)
└──────────────────────────────┘
```

### После
```
┌──────────────────────────────┐
│ [Нарисовать bbox]            │
│                              │
│ Блюда из чека:               │
│ #1 ...                       │
│ #2 ...                       │
│ ...                          │
└──────────────────────────────┘
```

**Все действия - через рисование bbox + dropdown выбора.**

---

## Симметрия функциональности

### Левая панель = Изображение (кроме drag/resize)

| Действие | Левая панель | Изображение |
|----------|-------------|-------------|
| Выбрать bbox | ✅ Клик | ✅ Клик |
| Удалить bbox | ✅ Кнопка 🗑️ | ✅ Hotkey `Del` |
| Создать bbox | ❌ | ✅ Рисование |
| Изменить размер | ❌ | ✅ Resize handles |
| Переместить | ❌ | ✅ Drag |
| Изменить блюдо | ✅ Dropdown | ✅ Toolbar → dropdown |

---

## Приоритеты изменений

### Phase 1: Структура данных
1. Развернуть варианты блюд в левом списке (все bbox видны)
2. Кнопка удаления для каждого bbox
3. Упростить hotkeys (убрать `X0Y`, оставить циклическую навигацию)

### Phase 2: Workflow
4. Dropdown после рисования (чек / активное меню / non-food)
5. Активное меню - поиск по AM таблице
6. Non-food объекты - hardcoded список

### Phase 3: UI cleanup
7. Перенести статус в header
8. Заменить "Сохранить" на "Done"
9. Убрать лишние кнопки ("Только выбранное", "Завершить", "Добавить")
10. Динамические hotkeys наверху (одна строка)

### Phase 4: "Ошибка в блюде"
11. Логика is_error для bbox
12. Автообновление статуса recognition

---

## Открытые вопросы

1. **Структура Active Menu в БД** - нужно уточнить у команды
2. **Non-food: нужны ли дополнительные типы?** (пока 6 базовых)
3. **Hotkeys: нужна ли настройка пользователем?** (пока hardcoded)
4. **Анимации переходов между bbox** - нужны или нет?

---

## Итоговый UX

### Пользовательский сценарий
1. Открыл recognition → видит список блюд из чека слева, изображение справа
2. Видит, что блюдо #2 имеет 2 bbox → оба видны в списке
3. Нажимает `2` → выбирается первый bbox блюда #2 на изображении
4. Нажимает `2` ещё раз → переходит ко второму bbox
5. Видит, что один bbox лишний → нажимает `Del` → удаляется
6. Видит hotkey hint наверху: "2 следующий | Del удалить"
7. Хочет добавить новое блюдо → нажимает "Нарисовать bbox"
8. Рисует → выбирает из dropdown (чек / меню / non-food)
9. Все готово → нажимает "Done" наверху → recognition completed

**Результат:** Чистый, интуитивный интерфейс без лишних элементов.

