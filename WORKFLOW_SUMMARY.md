# Workflow System - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç

## üìä –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ workflow –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π –∑–∞–¥–∞—á –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—ã–¥–∞—á–µ–π —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏.

### ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (5 –º–∏–≥—Ä–∞—Ü–∏–π)

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `task_types` - —Ç–∏–ø—ã –∑–∞–¥–∞—á —Å JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- `workflow_stages` - —ç—Ç–∞–ø—ã workflow
- `recognition_history` - –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `annotation_corrections` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ flow

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**
- `recognitions` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è workflow (tier, workflow_state, current_stage_id, completed_stages)

**–§—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã:**
- `calculate_recognition_tier()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (tier 1-5)
- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è tier –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

**View:**
- `recognitions_with_stats` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è workflow –ø–æ–ª–µ–π

### ‚úÖ API Endpoints (10 –Ω–æ–≤—ã—Ö)

**Workflow:**
- `GET /api/annotations/tasks/next` - –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É
- `POST /api/annotations/tasks/{id}/complete` - –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–∞–ø
- `POST /api/annotations/tasks/{id}/flag-correction` - –æ—Ç–º–µ—Ç–∏—Ç—å –æ—à–∏–±–∫—É

**–ò—Å—Ç–æ—Ä–∏—è:**
- `GET /api/annotations/recognitions/{id}/history` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `PUT /api/annotations/recognitions/{id}` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∞–≤—Ç–æ–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- `GET /api/annotations/task-types` - —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á
- `GET /api/annotations/task-stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º

**–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏:**
- `PUT /api/annotations/{id}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

**–≠–∫—Å–ø–æ—Ä—Ç:**
- `GET /api/annotations/export` - —ç–∫—Å–ø–æ—Ä—Ç –≤ JSON/CSV —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

### ‚úÖ UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (4 —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

**–ì–ª–∞–≤–Ω–∞—è:**
- `/annotations/tasks` - –¥–∞—à–±–æ—Ä–¥ —Å —Ç–∏–ø–∞–º–∏ –∑–∞–¥–∞—á –∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏

**–£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:**
- `/annotations/tasks/count_validation` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ bbox (2 —Ñ–æ—Ç–æ, —Å—á–µ—Ç—á–∏–∫–∏)
- `/annotations/tasks/dish_selection` - –≤—ã–±–æ—Ä –±–ª—é–¥–∞ (–∫—Ä—É–ø–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä 1-2-3)
- `/annotations/tasks/overlap_marking` - —Ä–∞–∑–º–µ—Ç–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π (Y/N, –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥)

**–ê–¥–º–∏–Ω—Å–∫–∏–π:**
- `/annotations/[id]` - –ø–æ–ª–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –Ω–µ –∏–∑–º–µ–Ω–µ–Ω)

### ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `WORKFLOW_IMPLEMENTATION.md` - –ø–æ–ª–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (270+ —Å—Ç—Ä–æ–∫)
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
  - –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
  - Troubleshooting
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ú–∏–≥—Ä–∞—Ü–∏–∏ (5):
```
supabase/migrations/
  ‚îú‚îÄ‚îÄ 20251106000000_create_workflow_tables.sql
  ‚îú‚îÄ‚îÄ 20251106000001_update_recognitions_for_workflow.sql
  ‚îú‚îÄ‚îÄ 20251106000002_seed_task_types_and_stages.sql
  ‚îú‚îÄ‚îÄ 20251106000003_tier_calculation_function.sql
  ‚îî‚îÄ‚îÄ 20251106000004_initialize_existing_recognitions.sql
```

### API (9 —Ñ–∞–π–ª–æ–≤):
```
src/app/api/annotations/
  ‚îú‚îÄ‚îÄ [id]/route.ts                           # PUT annotation
  ‚îú‚îÄ‚îÄ export/route.ts                         # GET export
  ‚îú‚îÄ‚îÄ task-types/route.ts                     # GET task types
  ‚îú‚îÄ‚îÄ task-stats/route.ts                     # GET statistics
  ‚îú‚îÄ‚îÄ tasks/
  ‚îÇ   ‚îú‚îÄ‚îÄ next/route.ts                       # GET next task
  ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
  ‚îÇ       ‚îú‚îÄ‚îÄ complete/route.ts               # POST complete
  ‚îÇ       ‚îî‚îÄ‚îÄ flag-correction/route.ts        # POST flag
  ‚îî‚îÄ‚îÄ recognitions/[id]/
      ‚îú‚îÄ‚îÄ route.ts                            # GET/PUT (updated)
      ‚îî‚îÄ‚îÄ history/route.ts                    # GET history
```

### UI (4 —Ñ–∞–π–ª–∞):
```
src/app/annotations/tasks/
  ‚îú‚îÄ‚îÄ page.tsx                                # Dashboard
  ‚îú‚îÄ‚îÄ count_validation/page.tsx               # Task UI
  ‚îú‚îÄ‚îÄ dish_selection/page.tsx                 # Task UI
  ‚îî‚îÄ‚îÄ overlap_marking/page.tsx                # Task UI
```

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (3 —Ñ–∞–π–ª–∞):
```
WORKFLOW_IMPLEMENTATION.md                    # –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
WORKFLOW_SUMMARY.md                           # –≠—Ç–æ—Ç —Ñ–∞–π–ª
DATASET_IMPORT.md                             # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç tier (1-5) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- Tier 1: –∏–¥–µ–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ (–≤—Å–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
- Tier 5: —Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏ (–º–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π)

### 2. –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –¢–∏–ø—ã –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ë–î
- UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ JSONB
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∑–∞–¥–∞—á

### 3. –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `recognition_history`
- Snapshots –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞

### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UX
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
- –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ
- Progress indicators

### 5. –ì–∏–±–∫–æ—Å—Ç—å
- Skip conditions –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ —ç—Ç–∞–ø–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–ª–∞–≥–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- –§–∏–ª—å—Ç—Ä—ã –ø–æ tier, date, workflow_state
- –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON/CSV

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **–í—Å–µ–≥–æ TODO:** 32 –∑–∞–¥–∞—á–∏
- **–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** 32 (100%)
- **–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:** 21
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~3500+
- **–ú–∏–≥—Ä–∞—Ü–∏–π:** 5
- **API endpoints:** 10 –Ω–æ–≤—ã—Ö + 1 –æ–±–Ω–æ–≤–ª–µ–Ω
- **UI —Å—Ç—Ä–∞–Ω–∏—Ü:** 4

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API endpoints
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UI workflow
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å tier calculation

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–±—É–¥—É—â–µ–µ):
1. –î–æ–±–∞–≤–∏—Ç—å `BottleOrientationUI`
2. –î–æ–±–∞–≤–∏—Ç—å `NonFoodObjectsUI`
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–ª–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º (—Ñ–ª–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
4. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (email/password)
5. Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## üéì –ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
cd /Users/romanshestakov/RRS/assisted-orders-nextjs
psql "$SUPABASE_CONNECTION_STRING" -f supabase/migrations/20251106000000_create_workflow_tables.sql
psql "$SUPABASE_CONNECTION_STRING" -f supabase/migrations/20251106000001_update_recognitions_for_workflow.sql
psql "$SUPABASE_CONNECTION_STRING" -f supabase/migrations/20251106000002_seed_task_types_and_stages.sql
psql "$SUPABASE_CONNECTION_STRING" -f supabase/migrations/20251106000003_tier_calculation_function.sql
psql "$SUPABASE_CONNECTION_STRING" -f supabase/migrations/20251106000004_initialize_existing_recognitions.sql

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server
npm run dev

# 3. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# http://localhost:3000/annotations/tasks
```

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é: `WORKFLOW_IMPLEMENTATION.md`

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ workflow –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∞–Ω–Ω–æ—Ç–∞—Ç–æ—Ä–æ–≤. 

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UX –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è
- –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:**
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ API –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è feedback –æ—Ç –∞–Ω–Ω–æ—Ç–∞—Ç–æ—Ä–æ–≤

---

**–í–µ—Ç–∫–∞:** `feature/annotation-workflow`  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-06  
**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude)

