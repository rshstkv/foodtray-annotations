name: Supabase Migrations

on:
  push:
    branches: [ main ]
    paths:
      - "supabase/migrations/**"
      - "supabase/**"
      - ".github/workflows/supabase-migrations.yml"
  workflow_dispatch:
    inputs:
      reset_database:
        description: 'Reset database (DANGER: drops all data and recreates from migrations)'
        required: false
        type: boolean
        default: false

jobs:
  db-push:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      # Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞµĞºÑ€ĞµÑ‚ SUPABASE_ACCESS_TOKEN Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      # Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ·Ğ°Ğ²ĞµÑÑ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ (Variables) SUPABASE_PROJECT_ID
      SUPABASE_PROJECT_ID: ${{ vars.SUPABASE_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate env
        run: |
          test -n "$SUPABASE_ACCESS_TOKEN" || { echo "SUPABASE_ACCESS_TOKEN is missing"; exit 1; }
          test -n "$SUPABASE_PROJECT_ID" || { echo "SUPABASE_PROJECT_ID variable is missing"; exit 1; }

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_ID"

      - name: Reset database (if requested)
        if: ${{ github.event.inputs.reset_database == 'true' }}
        run: |
          echo "ğŸ”´ RESETTING DATABASE - All data will be lost!"
          supabase db reset --linked --debug

      - name: Check for migration conflicts
        if: ${{ github.event.inputs.reset_database != 'true' }}
        id: check_conflicts
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ² ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ‘Ğ”
          REMOTE_MIGRATIONS=$(supabase migration list --linked 2>&1 || echo "")
          
          if echo "$REMOTE_MIGRATIONS" | grep -q "Remote migration versions not found"; then
            echo "conflicts=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Found migration conflicts"
          else
            echo "conflicts=false" >> $GITHUB_OUTPUT
            echo "âœ… No migration conflicts"
          fi

      - name: Repair migration history (if conflicts found)
        if: ${{ github.event.inputs.reset_database != 'true' && steps.check_conflicts.outputs.conflicts == 'true' }}
        run: |
          echo "ğŸ”§ Repairing migration history..."
          echo "Marking old migrations as reverted..."
          
          # ĞœĞ°Ñ€ĞºĞ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ğº reverted
          supabase migration repair --status reverted 20251112000000 || true
          supabase migration repair --status reverted 20251112190500 || true
          supabase migration repair --status reverted 20251113094728 || true
          supabase migration repair --status reverted 20251113120000 || true
          
          echo "âœ… Migration history repaired"

      - name: Push migrations to remote
        if: ${{ github.event.inputs.reset_database != 'true' }}
        run: |
          echo "ğŸ“¤ Pushing migrations to remote..."
          supabase db push --debug



