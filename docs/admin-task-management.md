# Управление задачами - Руководство администратора

## Обзор

Интерфейс управления задачами (`/admin/assign`) позволяет администраторам:
- Назначать задачи аннотаторам с различными комбинациями проверок
- Переназначать задачи между пользователями
- Просматривать статистику по назначениям

## Типы проверок

Система поддерживает 6 типов проверок:

1. **Блюда** (`validate_dishes`) - Проверка блюд из чека
2. **Перекрытия** (`check_overlaps`) - Отметка перекрытий блюд
3. **Баззеры** (`validate_buzzers`) - Проверка баззеров с цветами
4. **Бутылки** (`validate_bottles`) - Ориентация бутылок
5. **Другие предметы** (`validate_nonfood`) - Прочие объекты на подносе
6. **Тарелки** (`validate_plates`) - Проверка тарелок

## Режимы работы

### 1. Назначить задачи

Основной режим для создания новых назначений.

#### Параметры:

**Аннотаторы:**
- Выберите одного или нескольких аннотаторов
- Кнопки "Выбрать всех" / "Снять выбор"

**Фильтр (уже есть):**
- Выберите какие проверки УЖЕ должны быть в задачах
- Пусто = любые задачи
- Пример: выбрать "Блюда" = взять только задачи, у которых уже есть validate_dishes

**Назначить проверки:**
- Выберите какие проверки ДОБАВИТЬ к задачам
- По умолчанию: Блюда + Перекрытия + Тарелки
- Steps добавляются к существующим, а не заменяют их

**Параметры:**
- Количество задач на пользователя: 5, 10, 20, 50, 100
- Приоритет: Низкий, Средний, Высокий

#### Примеры использования:

**Сценарий 1: Первичная разметка**
```
Фильтр: пусто (любые задачи)
Назначить: Блюда + Перекрытия + Тарелки
Результат: Задачи с полным циклом базовых проверок
```

**Сценарий 2: Добавить баззеры к размеченным блюдам**
```
Фильтр: Блюда
Назначить: Баззеры
Результат: Задачи, у которых есть Блюда, получат дополнительно Баззеры
```

**Сценарий 3: Дополнительная проверка**
```
Фильтр: Блюда + Тарелки
Назначить: Бутылки + Другие предметы
Результат: Расширенная проверка для уже размеченных задач
```

### 2. Переназначить

Перенос задач от одного пользователя к другому.

**Параметры:**
- От пользователя (показывает текущее количество задач)
- К пользователю (показывает текущее количество задач)
- Количество: 5, 10, 20, 50 или "Все задачи"

**Применение:**
- Перераспределение нагрузки
- Передача задач при отсутствии аннотатора
- Балансировка очереди

### 3. Обзор

Просмотр статистики и текущего состояния.

**Статистика по типам задач:**
- Показывает все комбинации проверок в системе
- Количество задач для каждой комбинации
- Сколько назначено / свободно

**Назначения по пользователям:**
- Список всех пользователей с задачами
- Общее количество задач
- Разбивка по комбинациям проверок (scope)

## API Endpoints

### POST /api/admin/assign-tasks
Назначение задач аннотаторам.

```typescript
{
  user_ids: string[],
  task_count: number,
  priority: 'low' | 'medium' | 'high',
  scope: {
    steps: Array<{ id: string; name: string }>
  },
  filter_by_existing_scope?: string[] // Фильтр по существующим steps
}
```

### POST /api/admin/reassign-tasks
Переназначение задач.

```typescript
{
  from_user_id: string,
  to_user_id: string,
  task_count: number | 'all'
}
```

### GET /api/admin/scope-stats
Статистика по комбинациям проверок.

Возвращает:
```typescript
{
  scope_stats: Array<{
    scope_key: string,        // "validate_dishes+validate_plates"
    scope_names: string[],    // ["Блюда", "Тарелки"]
    total: number,
    assigned: number,
    unassigned: number
  }>
}
```

### GET /api/admin/user-assignments
Назначения по пользователям.

Возвращает:
```typescript
{
  assignments: Array<{
    user_id: string,
    user_email: string,
    task_count: number,
    by_scope: Record<string, number> // scope_key -> count
  }>
}
```

## Архитектурные особенности

### Мердж Steps
При назначении задач новые steps **добавляются** к существующим, а не заменяют их.

```typescript
// Было в задаче
task_scope: {
  steps: [
    { id: 'validate_dishes', name: 'Блюда' }
  ]
}

// Назначаем
scope: {
  steps: [
    { id: 'validate_buzzers', name: 'Баззеры' }
  ]
}

// Результат
task_scope: {
  steps: [
    { id: 'validate_dishes', name: 'Блюда' },
    { id: 'validate_buzzers', name: 'Баззеры' }
  ]
}
```

### Фильтрация
Фильтр `filter_by_existing_scope` проверяет что ВСЕ указанные steps присутствуют в задаче:

```typescript
filter_by_existing_scope: ['validate_dishes', 'validate_plates']
// Возьмет только задачи, у которых есть И validate_dishes, И validate_plates
```

### Админы как аннотаторы
Админы могут назначать задачи себе для тестирования или помощи команде.

## Рекомендации

### Стратегия назначения

1. **Первичная разметка** (приоритет: средний)
   - Блюда + Перекрытия + Тарелки
   - Количество: 20-50 задач на аннотатора

2. **Дополнительные проверки** (приоритет: низкий)
   - Фильтр: Блюда
   - Назначить: Баззеры + Бутылки + Другие предметы
   - Количество: 10-20 задач

3. **Срочные задачи** (приоритет: высокий)
   - Любая комбинация
   - Количество: 5-10 задач
   - Назначать опытным аннотаторам

### Балансировка нагрузки

- Регулярно проверяйте вкладку "Обзор"
- Используйте "Переназначить" для выравнивания очереди
- Следите за соотношением назначенных/свободных задач

### Мониторинг

Ключевые метрики на главном экране:
- **Всего задач** - общий объем
- **Не назначено** - требуют внимания
- **В работе** - текущая активность
- **Завершено** - прогресс

## Troubleshooting

### "No available tasks matching criteria"
- Проверьте фильтры - возможно слишком строгие
- Убедитесь что есть неназначенные задачи
- Попробуйте без фильтра по существующим scope

### Задачи не появляются у аннотатора
- Проверьте статус задач (должен быть 'pending')
- Убедитесь что assigned_to установлен правильно
- Проверьте что аннотатор имеет роль 'annotator'

### Неправильная комбинация steps
- Steps добавляются, а не заменяются
- Используйте фильтр для точного выбора задач
- Проверьте текущий scope в режиме "Обзор"

