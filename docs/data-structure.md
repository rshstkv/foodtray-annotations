# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –±–ª—é–¥

## –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Dataset)

### 1. qwen_annotations.json
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–∞: `data/recognition_XXXXX/photos/recognition_XXXXX_DATE_TYPE.jpg`

–°–æ–¥–µ—Ä–∂–∏—Ç:
```json
{
  "dishes": {
    "qwen_detections": [
      {
        "bbox_2d": [x1, y1, x2, y2],
        "label": "dish_N"  // N = dish_index
      }
    ],
    "correct_dishes_path": "recognition_XXXXX/XXXXX_recognition_DATE_correct_dishes.json"
  }
}
```

### 2. correct_dishes.json
–ü—É—Ç—å: `export_YYYYMMDD_HHMMSS/recognition_XXXXX/XXXXX_recognition_DATE_correct_dishes.json`

–°–æ–¥–µ—Ä–∂–∏—Ç **–¥–∞–Ω–Ω—ã–µ –∏–∑ —á–µ–∫–∞** (ground truth):
```json
[
  {
    "Count": 1,  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π –≤ —á–µ–∫–µ
    "Dishes": [  // –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –±–ª—é–¥ (–º–æ–∂–µ—Ç –±—ã—Ç—å >1 = –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å!)
      {
        "Name": "–ë–ª—é–¥–æ 1",
        "ExternalId": "..."
      },
      {
        "Name": "–ë–ª—é–¥–æ 2",  // –ï—Å–ª–∏ –µ—Å—Ç—å - –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å
        "ExternalId": "..."
      }
    ]
  }
]
```

**–í–ê–ñ–ù–û:** –ò–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ = `dish_index` –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π!

## –î–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ (Supabase)

### –¢–∞–±–ª–∏—Ü–∞ `recognitions`
```typescript
{
  recognition_id: string,
  dishes: Array<{
    count: number,           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —á–µ–∫–µ
    dishes: Array<{          // –°–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–µ—Å–ª–∏ >1 = –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å)
      name: string,
      external_id: string
    }>,
    name?: string,           // –ï—Å–ª–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é
    external_id?: string
  }>
}
```

### –¢–∞–±–ª–∏—Ü–∞ `annotations`
```typescript
{
  image_id: string,
  object_type: 'dish',
  dish_index: number,        // –ò–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ dishes (0-based)
  bbox: [x1, y1, x2, y2],
  custom_dish_name?: string, // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∏–∑ –º–µ–Ω—é
  is_deleted: boolean
}
```

### –¢–∞–±–ª–∏—Ü–∞ `tasks`
```typescript
{
  task_scope: {
    modified_dishes?: Array<{  // –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞ (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
      count: number,
      name: string,
      external_id: string
    }>
  }
}
```

## –ö–µ–π—Å—ã –∏ –ø—Ä–∏–º–µ—Ä—ã

### –ö–µ–π—Å 1: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –±–ª—é–¥–æ (1 –≤–∞—Ä–∏–∞–Ω—Ç, 1 –ø–æ—Ä—Ü–∏—è)
**–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "Count": 1,
  "Dishes": [{"Name": "–°–∞–ª–∞—Ç", "ExternalId": "123"}]
}
```

**–í –±–∞–∑–µ (recognitions.dishes[i]):**
```json
{
  "count": 1,
  "dishes": [{"name": "–°–∞–ª–∞—Ç", "external_id": "123"}]
}
```

**–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):**
- 1 bbox –Ω–∞ main –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å `dish_index = i`
- 1 bbox –Ω–∞ quality –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å `dish_index = i`

**UI:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: "–°–∞–ª–∞—Ç (1/1)" ‚úÖ
- –ö–Ω–æ–ø–∫–∏ +/- –ù–ï –ù–£–ñ–ù–´ (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)

---

### –ö–µ–π—Å 2: –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å (2 –≤–∞—Ä–∏–∞–Ω—Ç–∞, 1 –ø–æ—Ä—Ü–∏—è)
**–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "Count": 1,
  "Dishes": [
    {"Name": "Robalo Grelhado", "ExternalId": "111"},
    {"Name": "Dourada Grelhada", "ExternalId": "222"}
  ]
}
```

**–í –±–∞–∑–µ (recognitions.dishes[i]):**
```json
{
  "count": 1,
  "dishes": [
    {"name": "Robalo Grelhado", "external_id": "111"},
    {"name": "Dourada Grelhada", "external_id": "222"}
  ]
}
```

**–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):**
- 1 bbox –Ω–∞ main —Å `dish_index = i`
- 1 bbox –Ω–∞ quality —Å `dish_index = i`

**UI:**
- ‚ö†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: "Robalo Grelhado / Dourada Grelhada (1/1)"
- –¢—Ä–µ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç —á–µ—Ä–µ–∑ –º–µ–Ω—é
- –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ `custom_dish_name`

---

### –ö–µ–π—Å 3: –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ä—Ü–∏–π (1 –≤–∞—Ä–∏–∞–Ω—Ç, count > 1)
**–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "Count": 2,
  "Dishes": [{"Name": "–ü–∏–≤–æ", "ExternalId": "999"}]
}
```

**–í –±–∞–∑–µ:**
```json
{
  "count": 2,
  "dishes": [{"name": "–ü–∏–≤–æ", "external_id": "999"}]
}
```

**–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):**
- 2 bbox –Ω–∞ main —Å `dish_index = i`
- 2 bbox –Ω–∞ quality —Å `dish_index = i`

**UI:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: "–ü–∏–≤–æ (2/2)" ‚úÖ –∏–ª–∏ "–ü–∏–≤–æ (1/2)" ‚ö†Ô∏è –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç

---

### –ö–µ–π—Å 4: –û—à–∏–±–∫–∞ –≤ —á–µ–∫–µ (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
**–°–∏—Ç—É–∞—Ü–∏—è:** –í —á–µ–∫–µ —É–∫–∞–∑–∞–Ω–æ 2 –ø–æ—Ä—Ü–∏–∏, –Ω–æ –Ω–∞ —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ 1

**UI:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: "–ü–∏–≤–æ (1/2)" ‚ö†Ô∏è
- –ö–Ω–æ–ø–∫–∞ "-" —Ä—è–¥–æ–º —Å "2" –≤ —á–µ–∫–µ ‚Üí –∏–∑–º–µ–Ω—è–µ—Ç –Ω–∞ "1"
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `task_scope.modified_dishes`

## –í–∞–ª–∏–¥–∞—Ü–∏—è

### –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ!

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞ –Ω—É–∂–Ω–æ **–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ bbox** –Ω–∞ **–∫–∞–∂–¥–æ–º** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (main –∏ quality).

### –§–æ—Ä–º—É–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ dish_index:
```
count_in_receipt = correct_dishes[dish_index].Count

// –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ
count_on_main = COUNT(annotations WHERE 
  dish_index = i AND 
  is_deleted = false AND 
  image_type = 'main'
)

count_on_quality = COUNT(annotations WHERE 
  dish_index = i AND 
  is_deleted = false AND 
  image_type = 'quality'
)

// –°—Ç–∞—Ç—É—Å
main_status = count_on_main == count_in_receipt ? "‚úÖ" : "‚ö†Ô∏è"
quality_status = count_on_quality == count_in_receipt ? "‚úÖ" : "‚ö†Ô∏è"
```

### –ü—Ä–∏–º–µ—Ä—ã:

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```
–°–∞–ª–∞—Ç (Count=1 –≤ —á–µ–∫–µ)
  Main: 1/1 ‚úÖ
  Quality: 1/1 ‚úÖ
```

**–û—à–∏–±–∫–∞ - –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç:**
```
–ü–∏–≤–æ (Count=2 –≤ —á–µ–∫–µ)
  Main: 1/2 ‚ö†Ô∏è (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 1 bbox)
  Quality: 2/2 ‚úÖ
```

**–û—à–∏–±–∫–∞ - –ª–∏—à–Ω–∏–µ:**
```
Robalo/Dourada (Count=1 –≤ —á–µ–∫–µ)
  Main: 2/1 ‚ö†Ô∏è (–ª–∏—à–Ω–∏–π 1 bbox, –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)
  Quality: 2/1 ‚ö†Ô∏è (–ª–∏—à–Ω–∏–π 1 bbox, –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)
```

**–û—à–∏–±–∫–∞ –≤ —á–µ–∫–µ (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π):**
```
–ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –≤–∏–¥–Ω–æ 1 –ø–æ—Ä—Ü–∏—é, –∞ –≤ —á–µ–∫–µ —É–∫–∞–∑–∞–Ω–æ 2:
  Main: 1/2 ‚ö†Ô∏è
  Quality: 1/2 ‚ö†Ô∏è
  ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "-" —É —Ü–∏—Ñ—Ä—ã "2" –≤ —á–µ–∫–µ ‚Üí –º–µ–Ω—è–µ—Ç –Ω–∞ "1"
  ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ task_scope.modified_dishes
```

## –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏

–ö–æ–≥–¥–∞ –≤ —á–µ–∫–µ –¥–ª—è –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±–ª—é–¥ (`Dishes.length > 1`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–û–ë–Ø–ó–ê–ù** –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

### UI –¥–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏:

```
4. Robalo Grelhado / Dourada Grelhada ‚ö†Ô∏è –í–´–ë–ï–†–ò–¢–ï –í–ê–†–ò–ê–ù–¢
   Main: 2/1 ‚ö†Ô∏è
   Quality: 2/1 ‚ö†Ô∏è
   
   [–ö–Ω–æ–ø–∫–∞: –í—ã–±—Ä–∞—Ç—å –∏–∑ –º–µ–Ω—é]
```

–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç "–í—ã–±—Ä–∞—Ç—å –∏–∑ –º–µ–Ω—é"
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–∏—Å–∫ –ø–æ –º–µ–Ω—é —Å –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:
   - Robalo Grelhado
   - Dourada Grelhada
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `annotations[].custom_dish_name`
5. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –±–ª—é–¥–æ –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –í–∞–∂–Ω–æ:
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å **–±–ª–æ–∫–∏—Ä—É–µ—Ç** –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞
- –í—Å–µ bbox –¥–ª—è —ç—Ç–æ–≥–æ `dish_index` –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `custom_dish_name`
- –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ bbox)

## TODO –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ –°–∫—Ä–∏–ø—Ç –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç `correct_dishes` –≤ –±–∞–∑—É
2. ‚úÖ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ –æ—Ç–¥–µ–ª—å–Ω–æ (`Main: X/Y`, `Quality: X/Y`)
3. ‚úÖ –ö–Ω–æ–ø–∫–∏ +/- –º–µ–Ω—è—é—Ç `count` –≤ —á–µ–∫–µ (—Ä–µ–¥–∫–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `modified_dishes`)
4. üîÑ **–í –†–ê–ë–û–¢–ï:** UI –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏ (–∫–æ–≥–¥–∞ `Dishes.length > 1`)
   - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–í–´–ë–ï–†–ò–¢–ï –í–ê–†–ò–ê–ù–¢"
   - –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å –∏–∑ –º–µ–Ω—é" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
   - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `custom_dish_name` –¥–ª—è –≤—Å–µ—Ö bbox —ç—Ç–æ–≥–æ dish_index
5. ‚è≥ –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–∞—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å

