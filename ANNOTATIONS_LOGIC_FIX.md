# –ê–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π

## –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π:
- –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Ñ–ª–∞–≥–∏, dish_index, –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è, –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ, –æ—à–∏–±–∫–∞) –¥–æ–ª–∂–Ω—ã –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å—Å—è
- –û—Ç–∫–∞—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–ª—é–¥–∞/–æ–±—ä–µ–∫—Ç–∞
- –û—Ç–∫–∞—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—Å–µ–≥–æ recognition
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –ø—Ä–∞–≤—ã–º —Ç—É–ª–±–∞—Ä–æ–º (–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏) –∏ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª—å—é
- –ü–æ–Ω—è—Ç–Ω—ã–µ, –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∏–∫–æ–Ω–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### Frontend (Next.js App Router)
```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ annotations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx          # üî¥ –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ annotations/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ annotations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts          # üî¥ API: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (PUT/DELETE)
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ restore/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts      # üî¥ API: –æ—Ç–∫–∞—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (POST)
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ route.ts              # API: —Å–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (POST)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ recognitions/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ route.ts          # API: –ø–æ–ª—É—á–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ recognition
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ restore/
‚îÇ   ‚îÇ                   ‚îî‚îÄ‚îÄ route.ts      # API: –æ—Ç–∫–∞—Ç –≤—Å–µ–≥–æ recognition
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                          # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ BBoxAnnotator.tsx         # üî¥ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è bbox –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ supabase.ts               # –ö–ª–∏–µ–Ω—Ç Supabase
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase/PostgreSQL)
```
recognitions
‚îú‚îÄ‚îÄ id (bigint)
‚îú‚îÄ‚îÄ recognition_id (text, PK)
‚îú‚îÄ‚îÄ recognition_date (timestamp)
‚îú‚îÄ‚îÄ status (text: new/in_progress/completed)
‚îú‚îÄ‚îÄ is_mistake (boolean)
‚îú‚îÄ‚îÄ correct_dishes (jsonb)         # –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±–ª—é–¥ –∏–∑ —á–µ–∫–∞
‚îú‚îÄ‚îÄ annotator_notes (text)
‚îî‚îÄ‚îÄ has_modifications (boolean)    # –§–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

recognition_images
‚îú‚îÄ‚îÄ id (bigint, PK)
‚îú‚îÄ‚îÄ recognition_id (text, FK ‚Üí recognitions)
‚îú‚îÄ‚îÄ photo_type (text: Main/Qualifying)
‚îú‚îÄ‚îÄ storage_path (text)
‚îú‚îÄ‚îÄ image_width (int)
‚îú‚îÄ‚îÄ image_height (int)
‚îî‚îÄ‚îÄ original_annotations (jsonb)   # üî¥ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –æ—Ç QWEN

annotations
‚îú‚îÄ‚îÄ id (bigint, PK)
‚îú‚îÄ‚îÄ image_id (bigint, FK ‚Üí recognition_images)
‚îú‚îÄ‚îÄ object_type (text: food/non_food/plate)
‚îú‚îÄ‚îÄ object_subtype (text)
‚îú‚îÄ‚îÄ dish_index (int, nullable)
‚îú‚îÄ‚îÄ bbox_x1, bbox_y1, bbox_x2, bbox_y2 (numeric)
‚îú‚îÄ‚îÄ is_overlapped (boolean)
‚îú‚îÄ‚îÄ is_bottle_up (boolean, nullable)
‚îú‚îÄ‚îÄ is_error (boolean)
‚îî‚îÄ‚îÄ source (text: qwen_auto/manual)  # üî¥ –ü–†–û–ë–õ–ï–ú–ù–û–ï –ü–û–õ–ï
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ original_annotations (JSONB)
```json
{
  "qwen_dishes_detections": [
    {
      "bbox": [x1, y1, x2, y2],
      "bbox_2d": [x1, y1, x2, y2],
      "dish_index": 0 –∏–ª–∏ "0" –∏–ª–∏ null,
      "label": "dish_0",
      "is_bottle_up": true/false/null,
      "is_overlapped": false,
      "confidence": 0.95
    }
  ],
  "qwen_nonfood_detections": [...],
  "qwen_plate_detection": {...}
}
```

## –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ü—Ä–æ–±–ª–µ–º–∞ —Å Revert (–ö–†–ò–¢–ò–ß–ù–û)
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–≤–∏–≥–∞–µ—Ç bbox ‚Üí API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç `source = 'manual'` (route.ts:26)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert ‚Üí API –≤–∏–¥–∏—Ç `source = 'manual'` ‚Üí **–£–î–ê–õ–Ø–ï–¢** –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
- –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! Revert –¥–æ–ª–∂–µ–Ω –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –õ–Æ–ë–´–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∞ –Ω–µ —É–¥–∞–ª—è—Ç—å

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –ü–æ–ª–µ `source` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π:
  1. –û—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ (—Å—Ç–∞–≤–∏–º 'manual' –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏)
  2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è (qwen_auto vs manual)
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–µ—Ä—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –æ–Ω–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–∞ –æ—Ç QWEN

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:**
```
IF –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ original_annotations:
    ‚Üí —ç—Ç–æ QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–∞—è)
    ‚Üí Revert –¥–æ–ª–∂–µ–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ original_annotations
ELSE:
    ‚Üí —ç—Ç–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è
    ‚Üí Revert –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å –µ—ë
```

### 2. –ò–∫–æ–Ω–∫–∏ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω—ã/–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
- –ò–∫–æ–Ω–∫–∞ "–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ" (is_overlapped): ‚ö†Ô∏è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
- –ò–∫–æ–Ω–∫–∞ "–æ—à–∏–±–∫–∞" (is_error): —Å–µ–π—á–∞—Å AlertCircle, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –æ–Ω–∏ –ø–æ—Ö–æ–∂–∏
- –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ä–∞–∑–ª–∏—á–∞—é—â–∏–µ—Å—è –∏–∫–æ–Ω–∫–∏

### 3. –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –ø—Ä–∞–≤—ã–º —Ç—É–ª–±–∞—Ä–æ–º –∏ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª—å—é
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–≤–∏—Ç –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —Å–ø—Ä–∞–≤–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- –í –ª–µ–≤–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- –ü—Ä–∏—á–∏–Ω–∞: –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

### 4. –ö–Ω–æ–ø–∫–∞ Revert –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –°–µ–π—á–∞—Å: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `source === 'manual'`
- –ü—Ä–æ–±–ª–µ–º–∞: –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ `source` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 'manual', –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ —É–¥–∞–ª—è–µ—Ç –≤–º–µ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ

### –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
1. **Revert –æ—Ç–¥–µ–ª—å–Ω–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏**: –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, dish_index, —Ñ–ª–∞–≥–∏) –¥–æ–ª–∂–Ω—ã –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å—Å—è –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
2. **Revert –≤—Å–µ–≥–æ recognition**: –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª"
3. **–õ–æ–≥–∏–∫–∞ Revert**:
   - QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è (–±—ã–ª–∞ –≤ original_annotations) ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –í—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è ‚Üí —É–¥–∞–ª–∏—Ç—å

### –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
1. **–ö–Ω–æ–ø–∫–∞ Revert**:
   - –í–∏–¥–Ω–∞ –≤—Å–µ–≥–¥–∞
   - –ê–∫—Ç–∏–≤–Ω–∞ (—Å–µ—Ä–∞—è, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è) –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
   - Disabled (–æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–∞—è, –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è) –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç
2. **–ò–∫–æ–Ω–∫–∏**:
   - Revert: RotateCcw (—Å—Ç—Ä–µ–ª–∫–∞ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π)
   - Edit/Modify: Pencil (–∫–∞—Ä–∞–Ω–¥–∞—à)
   - –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ (is_overlapped): AlertTriangle (—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫) –∏–ª–∏ –¥—Ä—É–≥–∞—è –∏–∫–æ–Ω–∫–∞
   - –û—à–∏–±–∫–∞ (is_error): AlertCircle (–∫—Ä—É–≥ —Å –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º) –∏–ª–∏ XCircle
   - –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: —Å—Ç—Ä–µ–ª–∫–∏ ‚Üë ‚Üí ‚äô

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI
1. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ç—É–ª–±–∞—Ä ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –ª–µ–≤—É—é –ø–∞–Ω–µ–ª—å
2. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –ª–µ–≤—É—é –ø–∞–Ω–µ–ª—å ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Ç—É–ª–±–∞—Ä
3. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å—Å—è –≤–µ–∑–¥–µ

## –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "–µ—Å—Ç—å –ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª"
**–§–∞–π–ª**: `src/app/api/annotations/annotations/[id]/restore/route.ts`

–í–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ `source`, –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –≤ `original_annotations`:
```typescript
// –ò—â–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –≤ original_annotations –ø–æ dish_index
// –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
// –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí —É–¥–∞–ª—è–µ–º (—ç—Ç–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è)
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:**
1. –ü–æ `dish_index` (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Ç–æ—á–Ω–æ)
2. –ü–æ –ø—Ä–∏–º–µ—Ä–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (–¥–æ–ø—É—Å–∫ –¥–ª—è —Å–ª—É—á–∞—è –µ—Å–ª–∏ bbox –Ω–µ–º–Ω–æ–≥–æ –¥–≤–∏–Ω—É–ª–∏)
3. –ë—Ä–∞—Ç—å —Å–∞–º—ã–π –±–ª–∏–∑–∫–∏–π match –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
**–í–∞—Ä–∏–∞–Ω—Ç –ê**: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –ë–î `original_source` (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
**–í–∞—Ä–∏–∞–Ω—Ç –ë**: –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞ –ª–µ—Ç—É —á–µ—Ä–µ–∑ comparison —Å `original_annotations` (–ø—Ä–æ—â–µ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏)

–†–µ–∫–æ–º–µ–Ω–¥—É—é **–í–∞—Ä–∏–∞–Ω—Ç –ë**:
```typescript
// Frontend helper —Ñ—É–Ω–∫—Ü–∏—è
function hasModifications(annotation, original_annotations) {
  const original = findOriginalAnnotation(annotation, original_annotations)
  if (!original) return false // –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è
  
  return (
    annotation.bbox_x1 !== original.bbox_x1 ||
    annotation.bbox_y1 !== original.bbox_y1 ||
    annotation.bbox_x2 !== original.bbox_x2 ||
    annotation.bbox_y2 !== original.bbox_y2 ||
    annotation.dish_index !== original.dish_index ||
    annotation.is_overlapped !== original.is_overlapped ||
    annotation.is_bottle_up !== original.is_bottle_up
  )
}
```

### –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å UI –∫–Ω–æ–ø–∫–∏ Revert
**–§–∞–π–ª**: `src/app/annotations/[id]/page.tsx`

–ö–Ω–æ–ø–∫–∞ Revert –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:
- **–ê–∫—Ç–∏–≤–Ω–∞** –µ—Å–ª–∏ `hasModifications(annotation) === true`
- **Disabled** –µ—Å–ª–∏ `hasModifications(annotation) === false`
- **–°–∫—Ä—ã—Ç–∞** –µ—Å–ª–∏ —ç—Ç–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –®–∞–≥ 4: –ò–∑–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫–∏
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–ª–∏—á–∏—è:
- **–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ**: `AlertTriangle` (—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –∂–µ–ª—Ç—ã–π/–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
- **–û—à–∏–±–∫–∞**: `XCircle` (X –≤ –∫—Ä—É–≥–µ, –∫—Ä–∞—Å–Ω—ã–π) –∏–ª–∏ `AlertOctagon` (–≤–æ—Å—å–º–∏—É–≥–æ–ª—å–Ω–∏–∫)

### –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `handleAnnotationUpdate`:
1. –û–±–Ω–æ–≤–∏—Ç—å `images` state
2. –û–±–Ω–æ–≤–∏—Ç—å `selectedAnnotation` –µ—Å–ª–∏ —ç—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è
3. –û–±–Ω–æ–≤–∏—Ç—å `recognition.has_modifications`

## –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã Revert

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–≤–∏–∂–µ–Ω–∏–µ bbox
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–≤–∏–≥–∞–µ—Ç bbox ‚Üí `handleAnnotationUpdate` ‚Üí PUT /api/annotations/annotations/{id}
2. API —Å—Ç–∞–≤–∏—Ç `source = 'manual'` (route.ts:26)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert ‚Üí POST /api/annotations/annotations/{id}/restore
4. API –≤–∏–¥–∏—Ç `source = 'manual'` ‚Üí –∏—â–µ—Ç –≤ original_annotations
5. **–ü–†–û–ë–õ–ï–ú–ê**: –ï—Å–ª–∏ bbox –¥–≤–∏–Ω—É—Ç —Å–∏–ª—å–Ω–æ (>200px), original –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —É–¥–∞–ª—è–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ dish_index
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –±–ª—é–¥–æ ‚Üí `handleAnnotationUpdate` ‚Üí PUT /api/annotations/annotations/{id}
2. API —Å—Ç–∞–≤–∏—Ç `source = 'manual'` –∏ –º–µ–Ω—è–µ—Ç dish_index
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert ‚Üí POST /api/annotations/annotations/{id}/restore
4. **–ü–†–û–ë–õ–ï–ú–ê**: –ü–æ–∏—Å–∫ –≤ original_annotations –∏–¥—ë—Ç –ø–æ NEW dish_index (—Ç–µ–∫—É—â–∏–π), –∞ –Ω–∞–¥–æ –ø–æ OLD

### –†–µ—à–µ–Ω–∏–µ –¥–ª—è –°—Ü–µ–Ω–∞—Ä–∏—è 2
–ù—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å `original_dish_index` –∏–ª–∏ –∏—Å–∫–∞—Ç—å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º, –∞ –Ω–µ –ø–æ dish_index –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `original_id` –≤ –ë–î (—Å–ª–æ–∂–Ω–æ)
- –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∏–∑ QWEN —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª
- –ú–∏–Ω—É—Å: —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å snapshot –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (—Å—Ä–µ–¥–Ω–µ)
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `original_data` JSONB
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—É–¥–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–∏ Revert –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏–∑ `original_data`
- –ú–∏–Ω—É—Å: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 3: –£–ª—É—á—à–∏—Ç—å –ø–æ–∏—Å–∫ –≤ original_annotations (–ø—Ä–æ—â–µ, –†–ï–ö–û–ú–ï–ù–î–£–Æ)
**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü—Ä–∏ Revert –∏—â–µ–º –≤ original_annotations –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (—Ç–µ–∫—É—â–∏–º), –∞ –Ω–µ –ø–æ dish_index
2. –ù–∞—Ö–æ–¥–∏–º closest match –ø–æ —Ñ–æ—Ä–º—É–ª–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É bbox —Ü–µ–Ω—Ç—Ä–∞–º–∏
3. –ï—Å–ª–∏ closest match –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–∏–∑–∫–æ (—Ü–µ–Ω—Ç—Ä bbox –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 500px) ‚Üí —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –Ω–∞—à–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª
4. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª
5. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 500px ‚Üí —ç—Ç–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–∞—è ‚Üí —É–¥–∞–ª—è–µ–º

**–ö–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É bbox:**
```typescript
const currentCenterX = (annotation.bbox_x1 + annotation.bbox_x2) / 2
const currentCenterY = (annotation.bbox_y1 + annotation.bbox_y2) / 2

let closestMatch = null
let minDistance = Infinity

for (const detection of qwen_dishes_detections) {
  const bbox = detection.bbox_2d || detection.bbox
  const centerX = (bbox[0] + bbox[2]) / 2
  const centerY = (bbox[1] + bbox[3]) / 2
  
  const distance = Math.sqrt(
    Math.pow(centerX - currentCenterX, 2) + 
    Math.pow(centerY - currentCenterY, 2)
  )
  
  if (distance < minDistance && distance < 500) {
    minDistance = distance
    closestMatch = detection
  }
}
```

## –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∫–æ–¥–∞ –ø–æ —Ñ–∞–π–ª–∞–º

### 1. `src/app/annotations/[id]/page.tsx` (1700+ —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π

**–û—Å–Ω–æ–≤–Ω–æ–π State:**
```typescript
const [recognition, setRecognition] = useState<Recognition | null>(null)
const [images, setImages] = useState<RecognitionImage[]>([])  // üî¥ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
const [selectedAnnotation, setSelectedAnnotation] = useState<Annotation | null>(null)
const [drawingMode, setDrawingMode] = useState(false)
const [currentPhotoType, setCurrentPhotoType] = useState<'Main' | 'Qualifying'>('Main')
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `fetchRecognition()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç recognition –∏ images —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏ –∏–∑ API
- `handleAnnotationUpdate(id, updates)` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Ñ–ª–∞–≥–∏)
  - –°—Ç—Ä–æ–∫–∞ ~456-520
  - –ü—Ä–æ–±–ª–µ–º–∞: —Å—Ç–∞–≤–∏—Ç `source: 'manual'` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ dish_index –∏–ª–∏ bbox
- `handleAnnotationRestore(id)` - –≤—ã–∑—ã–≤–∞–µ—Ç API restore –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
  - –°—Ç—Ä–æ–∫–∞ ~575-592
- `handleAnnotationDelete(id)` - —É–¥–∞–ª—è–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
- `changeDishForAnnotation()` - –º–µ–Ω—è–µ—Ç dish_index –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ UI:**
- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –∏–∑ —á–µ–∫–∞ –∏ –∏—Ö bbox
  - –°—Ç—Ä–æ–∫–∏ ~835-1100
  - –ö–Ω–æ–ø–∫–∏: Revert, Edit, Overlapped, Orientation, Delete
- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å BBoxAnnotator
  - –°—Ç—Ä–æ–∫–∏ ~1200+
- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª—é–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏
  - –°—Ç—Ä–æ–∫–∏ ~1450-1690

**–ì–¥–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è Revert:**
1. –í –æ—Å–Ω–æ–≤–Ω–æ–º —Å–ø–∏—Å–∫–µ –±–ª—é–¥–∞ (—Å—Ç—Ä–æ–∫–∞ ~897-913)
2. –í –ø–æ–¥—Å–ø–∏—Å–∫–µ bbox –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ (—Å—Ç—Ä–æ–∫–∞ ~1006-1030)
3. –í —Å–ø–∏—Å–∫–µ non-food –æ–±—ä–µ–∫—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~1118-1150)

**–ü—Ä–æ–±–ª–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ BBoxAnnotator –Ω–µ —Å—Ä–∞–∑—É –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
- –§–ª–∞–≥–∏ (is_error, is_overlapped) –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### 2. `src/components/BBoxAnnotator.tsx` (~670 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: Canvas-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è bbox –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏

**Props:**
```typescript
interface BBoxAnnotatorProps {
  imageUrl: string
  annotations: Annotation[]
  selectedAnnotation: Annotation | null
  onAnnotationUpdate: (id: number, updates: any) => void
  onAnnotationSelect: (annotation: Annotation | null) => void
  onChangeDish?: (id: number, rect: any) => void
  onDelete?: () => void
  onToggleOverlapped?: (id: number) => void
  onToggleOrientation?: (id: number) => void
  // ...
}
```

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –†–∏—Å—É–µ—Ç bbox –ø–æ–≤–µ—Ä—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- Toolbar –Ω–∞–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–º bbox —Å –∫–Ω–æ–ø–∫–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ ~595-660):
  - Pencil (–∏–∑–º–µ–Ω–∏—Ç—å –±–ª—é–¥–æ)
  - AlertTriangle (–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ)
  - –°—Ç—Ä–µ–ª–∫–∏ (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è)
  - Delete (—É–¥–∞–ª–∏—Ç—å)
  - ‚ùå –ù–ï–¢ –∫–Ω–æ–ø–∫–∏ Revert –∑–¥–µ—Å—å

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –æ—à–∏–±–∫–∏ (is_error) –Ω–∞ —Ç—É–ª–±–∞—Ä–µ
- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ Revert –Ω–∞ —Ç—É–ª–±–∞—Ä–µ

### 3. `src/app/api/annotations/annotations/[id]/route.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

**PUT endpoint (—Å—Ç—Ä–æ–∫–∏ 4-97):**
```typescript
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
const updates: any = {}
if (body.bbox_x1 !== undefined) updates.bbox_x1 = body.bbox_x1
// ...
if (body.is_error !== undefined) updates.is_error = body.is_error

// üî¥ –ü–†–û–ë–õ–ï–ú–ê: –≤—Å–µ–≥–¥–∞ —Å—Ç–∞–≤–∏—Ç source = 'manual'
updates.source = 'manual'  // –°—Ç—Ä–æ–∫–∞ 26

await supabase.from('annotations').update(updates).eq('id', annotationId)
```

**DELETE endpoint (—Å—Ç—Ä–æ–∫–∏ 99-163):**
- –£–¥–∞–ª—è–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
- –û–±–Ω–æ–≤–ª—è–µ—Ç has_modifications –≤ recognition

### 4. `src/app/api/annotations/annotations/[id]/restore/route.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: API –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É

**POST endpoint:**
```typescript
// 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
const currentAnnotation = await supabase.from('annotations').select('*').eq('id', annotationId).single()

// 2. –ü–æ–ª—É—á–∏—Ç—å original_annotations –∏–∑ recognition_images
const image = await supabase.from('recognition_images')
  .select('original_annotations')
  .eq('id', currentAnnotation.image_id)
  .single()

// 3. –ü–æ–∏—Å–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –≤ original_annotations
// üî¥ –ü–†–û–ë–õ–ï–ú–ê: –ø–æ–∏—Å–∫ –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª
for (const detection of originalAnnotations.qwen_dishes_detections) {
  // –ò—â–µ—Ç –ø–æ dish_index –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
  if (detectionDishIndex === currentAnnotation.dish_index && totalDiff < 200) {
    // –ù–∞—à–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª
  }
}

// 4. –ï—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞–π–¥–µ–Ω ‚Üí UPDATE, –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí DELETE
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ü–æ–∏—Å–∫ –ø–æ `current dish_index` - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ–Ω—è–ª dish_index, –Ω–µ –Ω–∞–π–¥–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª
- –î–æ–ø—É—Å–∫ 200px –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ –µ—Å–ª–∏ bbox —Å–∏–ª—å–Ω–æ –¥–≤–∏–Ω—É–ª–∏
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª—é–±—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–µ—Ä—è–µ—Ç—Å—è —Å–≤—è–∑—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º

### 5. `src/app/api/annotations/recognitions/[id]/route.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è recognition

**GET endpoint:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç recognition —Å images –∏ annotations
- –í–∫–ª—é—á–∞–µ—Ç original_annotations –¥–ª—è –∫–∞–∂–¥–æ–≥–æ image

**PUT endpoint:**
- –û–±–Ω–æ–≤–ª—è–µ—Ç correct_dishes, status, notes

### 6. `src/app/api/annotations/recognitions/[id]/restore/route.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–∫–∞—Ç –≤—Å–µ–≥–æ recognition –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É

**–†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
1. –£–¥–∞–ª—è–µ—Ç –≤—Å–µ annotations –¥–ª—è recognition
2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –∏—Ö –∏–∑ original_annotations
3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç status = 'new'

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–≤–∏–≥–∞–µ—Ç bbox

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—è–Ω–µ—Ç bbox –≤ BBoxAnnotator
   ‚Üì
2. BBoxAnnotator –≤—ã–∑—ã–≤–∞–µ—Ç onAnnotationUpdate(id, {bbox_x1, bbox_y1, ...})
   ‚Üì
3. page.tsx handleAnnotationUpdate():
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π state (images, selectedAnnotation)
   - –í—ã–∑—ã–≤–∞–µ—Ç PUT /api/annotations/annotations/{id}
   ‚Üì
4. API route.ts:
   - –ü–æ–ª—É—á–∞–µ—Ç updates
   - —Å—Ç–∞–≤–∏—Ç updates.source = 'manual'  ‚Üê üî¥ –¢–ï–†–Ø–ï–ú –°–í–Ø–ó–¨ –° –û–†–ò–ì–ò–ù–ê–õ–û–ú
   - UPDATE annotations SET ... WHERE id = {id}
   - UPDATE recognitions SET has_modifications = true
   ‚Üì
5. Frontend –æ–±–Ω–æ–≤–ª–µ–Ω, –Ω–æ:
   - –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚úÖ
   - –ö–Ω–æ–ø–∫–∞ Revert —Ç–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–Ω–∞ ‚úÖ
   - –ù–û –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Revert ‚Üí —É–¥–∞–ª–∏—Ç—Å—è –≤–º–µ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚ùå
```

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert

```
1. –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É Revert –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
   ‚Üì
2. page.tsx handleAnnotationRestore(id):
   - POST /api/annotations/annotations/{id}/restore
   ‚Üì
3. API restore route.ts:
   - –ß–∏—Ç–∞–µ—Ç annotations WHERE id = {id}
   - –ß–∏—Ç–∞–µ—Ç original_annotations –∏–∑ recognition_images
   - –ò—â–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –ø–æ dish_index + –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
   
   CASE A: –û—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞–π–¥–µ–Ω
     ‚Üí UPDATE annotations —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
     ‚Üí source = 'qwen_auto'
   
   CASE B: –û—Ä–∏–≥–∏–Ω–∞–ª –ù–ï –Ω–∞–π–¥–µ–Ω  ‚Üê üî¥ –°–Æ–î–ê –ü–û–ü–ê–î–ê–ï–ú
     ‚Üí DELETE annotations WHERE id = {id}
   ‚Üì
4. Frontend –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (fetchRecognition)
   - –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ ‚ùå
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç MD —Ñ–∞–π–ª —Å –∞–Ω–∞–ª–∏–∑–æ–º
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–ø–æ —Ü–µ–Ω—Ç—Ä—É bbox)
3. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î –ø–æ–ª–µ –¥–ª—è —Å–≤—è–∑–∏ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. ‚¨ú –ò–∑–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫–∏ (–æ—à–∏–±–∫–∞ vs –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ)
5. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é `hasModifications()` –Ω–∞ frontend
6. ‚¨ú –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Revert –Ω–∞ –æ—Å–Ω–æ–≤–µ `hasModifications()`
7. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É —Ç—É–ª–±–∞—Ä–æ–º –∏ –ø–∞–Ω–µ–ª—å—é
8. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—à–∏–±–∫–∏ –Ω–∞ —Ç—É–ª–±–∞—Ä BBoxAnnotator
9. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## –¢–µ—Å—Ç-–∫–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### TC1: Revert –ø–æ—Å–ª–µ –¥–≤–∏–∂–µ–Ω–∏—è bbox
1. –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é —Å QWEN –æ–±—ä–µ–∫—Ç–∞–º–∏
2. –î–≤–∏–Ω—É—Ç—å bbox –Ω–∞ 50px –≤–ø—Ä–∞–≤–æ
3. –ù–∞–∂–∞—Ç—å Revert
4. **–û–∂–∏–¥–∞–Ω–∏–µ**: bbox –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
5. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: bbox —É–¥–∞–ª—è–µ—Ç—Å—è ‚ùå

### TC2: Revert –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è dish_index
1. –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
2. –ò–∑–º–µ–Ω–∏—Ç—å –±–ª—é–¥–æ —Å #1 –Ω–∞ #2
3. –ù–∞–∂–∞—Ç—å Revert
4. **–û–∂–∏–¥–∞–Ω–∏–µ**: –±–ª—é–¥–æ –≤–µ—Ä–Ω—É–ª–æ—Å—å –Ω–∞ #1
5. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –æ–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è ‚ùå

### TC3: Revert –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π bbox –≤—Ä—É—á–Ω—É—é (–∫–Ω–æ–ø–∫–∞ D)
2. –ù–∞–∂–∞—Ç—å Revert
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: bbox —É–¥–∞–ª—è–µ—Ç—Å—è
4. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: ?

### TC4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—à–∏–±–∫–∏
1. –í—ã–±—Ä–∞—Ç—å bbox
2. –ù–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø—Ä–∞–≤–∞ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—à–∏–±–∫–∞"
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –ø–æ—è–≤–∏–ª–∞—Å—å –∏–∫–æ–Ω–∫–∞ –æ—à–∏–±–∫–∏ —Ä—è–¥–æ–º —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
4. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –∏–∫–æ–Ω–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è ‚ùå

### TC5: –ö–Ω–æ–ø–∫–∞ Revert disabled –¥–ª—è –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö
1. –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é —Å QWEN –æ–±—ä–µ–∫—Ç–∞–º–∏
2. –ù–µ –≤–Ω–æ—Å–∏—Ç—å –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: –∫–Ω–æ–ø–∫–∞ Revert –≤–∏–¥–Ω–∞ –Ω–æ disabled (—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä–∞—è)
4. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –∫–Ω–æ–ø–∫–∞ disabled –µ—Å–ª–∏ source !== 'manual' (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### TC6: –ö–Ω–æ–ø–∫–∞ Revert active –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
1. –û—Ç–∫—Ä—ã—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
2. –ò–∑–º–µ–Ω–∏—Ç—å is_overlapped
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: –∫–Ω–æ–ø–∫–∞ Revert —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–∞—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è)
4. **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π, –Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ —É–¥–∞–ª—è–µ—Ç ‚ùå

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞

### –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏
1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. –ò–∑—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—Å–º. —Ä–∞–∑–¥–µ–ª "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")
3. –ü–æ–Ω—è—Ç—å —á—Ç–æ —Ç–∞–∫–æ–µ `original_annotations` - —ç—Ç–æ snapshot –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç QWEN
4. –û—Ç–∫—Ä—ã—Ç—å `src/app/annotations/[id]/page.tsx` - –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª UI
5. –û—Ç–∫—Ä—ã—Ç—å `src/app/api/annotations/annotations/[id]/restore/route.ts` - –ø—Ä–æ–±–ª–µ–º–Ω—ã–π API endpoint

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

**–î–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏:**
1. **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ** - —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `recognition_images.original_annotations` (JSONB)
2. **–¢–µ–∫—É—â–µ–µ** - —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `annotations`

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π:**
- `source = 'qwen_auto'` - —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–¥–µ–ª—å—é QWEN
- `source = 'manual'` - —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ò–õ–ò –∏–∑–º–µ–Ω–µ–Ω—ã (—Ç–µ—Ä—è–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)

**–¢–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã bbox (bbox_x1, bbox_y1, bbox_x2, bbox_y2)
- dish_index (–∫–∞–∫–æ–µ –±–ª—é–¥–æ)
- is_overlapped (—Ñ–ª–∞–≥ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è)
- is_bottle_up (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ/–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)
- is_error (—Ñ–ª–∞–≥ –æ—à–∏–±–∫–∏ - –æ–±—ä–µ–∫—Ç –Ω–µ –≤ –º–µ–Ω—é/—á–µ–∫–µ)
- object_type, object_subtype (–ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º:**
```
QWEN —Å–æ–∑–¥–∞–ª bbox —Å dish_index=0, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã [100,100,200,200]
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–≤–∏–Ω—É–ª bbox –Ω–∞ [150,150,250,250]
  ‚Üì
API —Å—Ç–∞–≤–∏—Ç source='manual'  ‚Üê –¢–ï–†–Ø–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert
  ‚Üì
API –∏—â–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –ø–æ dish_index=0 –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º [150,150,250,250]
  ‚Üì
–ù–∞—Ö–æ–¥–∏—Ç –≤ original_annotations bbox —Å [100,100,200,200]
–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ = 141px (–ø–æ —Ñ–æ—Ä–º—É–ª–µ –ü–∏—Ñ–∞–≥–æ—Ä–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–æ–≤)
  ‚Üì
‚úÖ –ï—Å–ª–∏ –¥–æ–ø—É—Å–∫ 200px - –Ω–∞—Ö–æ–¥–∏—Ç, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
‚ùå –ï—Å–ª–∏ bbox –ø–æ–¥–≤–∏–Ω—É–ª–∏ –¥–∞–ª–µ–∫–æ - –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç, —É–¥–∞–ª—è–µ—Ç
```

**–ï—â–µ —Ö—É–∂–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º dish_index:**
```
QWEN —Å–æ–∑–¥–∞–ª bbox —Å dish_index=0
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ–Ω—è–ª –Ω–∞ dish_index=1
  ‚Üì
API —Å—Ç–∞–≤–∏—Ç source='manual', dish_index=1
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Revert
  ‚Üì
API –∏—â–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –ø–æ dish_index=1  ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!
  ‚Üì
–í original_annotations –Ω–µ—Ç dish_index=1 –¥–ª—è —ç—Ç–æ–≥–æ bbox
  ‚Üì
‚ùå –£–¥–∞–ª—è–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
```

### –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `original_bbox_id` –≤ –ë–î**
- –ü–ª—é—Å—ã: –ù–∞–¥–µ–∂–Ω–∞—è —Å–≤—è–∑—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
- –ú–∏–Ω—É—Å—ã: –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π

**–í–∞—Ä–∏–∞–Ω—Ç 2: –•—Ä–∞–Ω–∏—Ç—å snapshot –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `original_state` JSONB –≤ —Ç–∞–±–ª–∏—Ü—É `annotations`
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ QWEN –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç—É–¥–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–∏ Revert –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏–∑ `original_state`
- –ü–ª—é—Å—ã: –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- –ú–∏–Ω—É—Å—ã: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–í–∞—Ä–∏–∞–Ω—Ç 3: –£–ª—É—á—à–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**
- –ò—Å–∫–∞—Ç—å –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏ bbox, –∞ –Ω–µ –ø–æ dish_index
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–æ–π –¥–æ–ø—É—Å–∫ (500-1000px)
- –ë—Ä–∞—Ç—å —Å–∞–º—ã–π –±–ª–∏–∑–∫–∏–π match
- –ü–ª—é—Å—ã: –ù–µ –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- –ú–∏–Ω—É—Å—ã: –ú–æ–∂–µ—Ç –æ—à–∏–±–∏—Ç—å—Å—è –µ—Å–ª–∏ –¥–≤–∞ bbox –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ

**–í–∞—Ä–∏–∞–Ω—Ç 4: –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ `source` –Ω–∞ `original_source` + `is_modified`**
- `original_source`: qwen_auto / manual (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
- `is_modified`: boolean (true –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
- –ü–ª—é—Å—ã: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è
- –ú–∏–Ω—É—Å—ã: –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è, –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–æ–∏—Å–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

### –ß—Ç–æ —á–∏—Ç–∞—Ç—å –≤ –∫–æ–¥–µ

**–§–∞–π–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω—É–∂–Ω–æ –∏–∑—É—á–∏—Ç—å:**
1. `src/app/annotations/[id]/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 456-520, 575-592, 897-913)
2. `src/app/api/annotations/annotations/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∞ 26 - —Å—Ç–∞–≤–∏—Ç source='manual')
3. `src/app/api/annotations/annotations/[id]/restore/route.ts` (–≤–µ—Å—å —Ñ–∞–π–ª - –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞)
4. `src/components/BBoxAnnotator.tsx` (—Å—Ç—Ä–æ–∫–∏ 595-660 - —Ç—É–ª–±–∞—Ä)

**–í–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `handleAnnotationUpdate()` - –≥–¥–µ —Å—Ç–∞–≤–∏—Ç—Å—è source='manual'
- `handleAnnotationRestore()` - –≤—ã–∑—ã–≤–∞–µ—Ç restore API
- –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –≤ restore endpoint

**–ì–¥–µ –∫–Ω–æ–ø–∫–∞ Revert:**
- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å, 3 –º–µ—Å—Ç–∞ (–æ—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ, –ø–æ–¥-bbox, non-food)
- –ù–ï–¢ –Ω–∞ —Ç—É–ª–±–∞—Ä–µ –Ω–∞–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **original_annotations - –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π snapshot**
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ QWEN
   - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
   - –≠—Ç–æ –Ω–∞—à "–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã" –¥–ª—è –æ—Ç–∫–∞—Ç–∞

2. **–¢–∞–±–ª–∏—Ü–∞ annotations - –∏–∑–º–µ–Ω—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**
   - –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
   - –ú–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
   - –ú–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç original_annotations

3. **has_modifications —Ñ–ª–∞–≥ –Ω–∞ recognition**
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ recognition –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏

4. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI**
   - –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: list-view –±–ª—é–¥ –∏ bbox
   - –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: canvas —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ bbox
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ shared state (images, selectedAnnotation)

5. **–ò–∫–æ–Ω–∫–∏ (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ lucide-react):**
   - RotateCcw - –æ—Ç–∫–∞—Ç
   - Pencil - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - AlertTriangle - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ/–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ (—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫)
   - AlertCircle - –æ—à–∏–±–∫–∞ (–∫—Ä—É–≥)
   - XCircle - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –æ—à–∏–±–∫–∏

### –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞

**–®–∞–≥ 1: –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç MD —Ñ–∞–π–ª
- [ ] –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î
- [ ] –ü–æ–Ω—è—Ç—å flow –¥–∞–Ω–Ω—ã—Ö (—Å–º. —Ä–∞–∑–¥–µ–ª "–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö")

**–®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ restore endpoint**
- [ ] –û—Ç–∫—Ä—ã—Ç—å `src/app/api/annotations/annotations/[id]/restore/route.ts`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É bbox (—Å–º. –í–∞—Ä–∏–∞–Ω—Ç 3)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫**
- [ ] –û—Ç–∫—Ä—ã—Ç—å `src/app/annotations/[id]/page.tsx` –∏ `src/components/BBoxAnnotator.tsx`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫–∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∏ –æ—à–∏–±–∫–∏ –Ω–∞ –±–æ–ª–µ–µ —Ä–∞–∑–ª–∏—á–∞—é—â–∏–µ—Å—è

**–®–∞–≥ 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —á–µ—Ä–µ–∑ BBoxAnnotator
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ñ–ª–∞–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ

**–®–∞–≥ 5: –£–ª—É—á—à–µ–Ω–∏–µ UX –∫–Ω–æ–ø–∫–∏ Revert**
- [ ] –î–æ–±–∞–≤–∏—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é hasModifications()
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å Revert disabled –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å Revert –Ω–∞ —Ç—É–ª–±–∞—Ä BBoxAnnotator

**–®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –ü—Ä–æ–π—Ç–∏ –≤—Å–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å edge cases (—Å–∏–ª—å–Ω–æ –ø–æ–¥–≤–∏–Ω—É—Ç—ã–π bbox, —Å–º–µ–Ω–∞ dish_index –∏ —Ç.–¥.)

### –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. –ù—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É Revert –Ω–∞ —Ç—É–ª–±–∞—Ä –Ω–∞–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (BBoxAnnotator)?
2. –ö–∞–∫–æ–π –¥–æ–ø—É—Å–∫ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (500px, 1000px)?
3. –ù—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" —Ä—è–¥–æ–º —Å bbox –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏?
4. –ö–∞–∫ –ø–æ—Å—Ç—É–ø–∞—Ç—å –µ—Å–ª–∏ –≤ original_annotations –Ω–µ—Å–∫–æ–ª—å–∫–æ bbox –±–ª–∏–∑–∫–æ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É?

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-05  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–°—Ç–∞—Ç—É—Å**: –ü—Ä–æ–±–ª–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, –æ–∂–∏–¥–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

